name: CI/CD Pipeline with OIDC

# OIDC í† í°ì„ ìƒì„±í•˜ê¸° ìœ„í•œ ê¶Œí•œ ì„¤ì •
permissions:
  id-token: write # ì´ ê¶Œí•œì€ í•„ìˆ˜ì…ë‹ˆë‹¤.
  contents: read

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Seoul
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: arn:aws:iam::733995297457:role/GitHub_Actions
          aws-region: ap-northeast-2

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Set image tag with date and time
        id: vars
        run: echo "current_time=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Build, tag, and push image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: booking-service
          IMAGE_TAG: ${{ steps.vars.outputs.current_time }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          echo "âœ… Images pushed successfully:"
          echo "  - $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          echo "  - $ECR_REGISTRY/$ECR_REPOSITORY:latest"
          echo "registry=$ECR_REGISTRY" >> $GITHUB_OUTPUT

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Seoul
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: arn:aws:iam::733995297457:role/GitHub_Actions
          aws-region: ap-northeast-2

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Get current task definition
        id: get-task-def
        run: |
          echo "ğŸ” Getting current task definition..."
          
          # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ íƒœìŠ¤í¬ ì •ì˜ ê°€ì ¸ì˜¤ê¸°
          CURRENT_TASK_DEF=$(aws ecs describe-services \
            --cluster fog-cluster \
            --services booking-service \
            --region ap-northeast-2 \
            --query 'services[0].taskDefinition' \
            --output text)
          
          echo "current_task_def=$CURRENT_TASK_DEF" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Current task definition: $CURRENT_TASK_DEF"
          
          # íƒœìŠ¤í¬ ì •ì˜ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          aws ecs describe-task-definition \
            --task-definition $CURRENT_TASK_DEF \
            --region ap-northeast-2 \
            --output json > current-task-definition.json
          
          echo "ğŸ“„ Task definition details saved to current-task-definition.json"

      - name: Update task definition with new image
        run: |
          echo "ğŸ”„ Updating task definition with new image..."
          
          # ìƒˆë¡œìš´ ì´ë¯¸ì§€ë¡œ íƒœìŠ¤í¬ ì •ì˜ ì—…ë°ì´íŠ¸
          # ECR ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì§ì ‘ ê°€ì ¸ì˜¤ê¸°
          ECR_REGISTRY="733995297457.dkr.ecr.ap-northeast-2.amazonaws.com"
          NEW_IMAGE="$ECR_REGISTRY/booking-service:latest"
          
          echo "ğŸ–¼ï¸ New image: $NEW_IMAGE"
          
          # JSON êµ¬ì¡° ì™„ì „ ì¬êµ¬ì„±: taskDefinition í‚¤ ì œê±°í•˜ê³  í•„ìš”í•œ í•„ë“œë§Œ ì¶”ì¶œ
          echo "ğŸ”§ Restructuring JSON for ECS registration..."
          
          # ë¨¼ì € JSON êµ¬ì¡° í™•ì¸
          echo "ğŸ“‹ Current JSON structure:"
          cat current-task-definition.json | jq 'keys'
          
          # ì˜¬ë°”ë¥¸ ê²½ë¡œë¡œ ë°ì´í„° ì¶”ì¶œ (taskDefinition í‚¤ ë‚´ë¶€ì—ì„œ)
          # None ê°’ì´ ì•„ë‹Œ í•„ë“œë§Œ í¬í•¨
          jq '{
            family: .taskDefinition.family,
            executionRoleArn: .taskDefinition.executionRoleArn,
            taskRoleArn: .taskDefinition.taskRoleArn,
            networkMode: .taskDefinition.networkMode,
            requiresCompatibilities: .taskDefinition.requiresCompatibilities,
            cpu: .taskDefinition.cpu,
            memory: .taskDefinition.memory,
            containerDefinitions: .taskDefinition.containerDefinitions,
            volumes: .taskDefinition.volumes,
            placementConstraints: .taskDefinition.placementConstraints
          } | with_entries(select(.value != null))' current-task-definition.json > new-task-definition.json
          
          # ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
          jq '.containerDefinitions[0].image = "'$NEW_IMAGE'"' new-task-definition.json > temp.json && mv temp.json new-task-definition.json
          
          # JSON êµ¬ì¡° ê²€ì¦
          echo "ğŸ” Validating JSON structure..."
          cat new-task-definition.json | jq '.family' > /dev/null
          cat new-task-definition.json | jq '.containerDefinitions' > /dev/null
          echo "âœ… JSON structure validation passed"
          
          echo "ğŸ†• New task definition created with image: $NEW_IMAGE"
          
          # íƒœìŠ¤í¬ ì •ì˜ ë“±ë¡
          NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://new-task-definition.json \
            --region ap-northeast-2 \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          
          echo "new_task_def_arn=$NEW_TASK_DEF_ARN" >> $GITHUB_OUTPUT
          echo "âœ… New task definition registered: $NEW_TASK_DEF_ARN"

      - name: Deploy to Amazon ECS
        run: |
          echo "ğŸš€ Deploying to Amazon ECS..."
          
          # ECS ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸
          aws ecs update-service \
            --cluster fog-cluster \
            --service booking-service \
            --task-definition ${{ steps.get-task-def.outputs.current_task_def }} \
            --region ap-northeast-2
          
          echo "âœ… ECS service updated successfully"

      - name: Wait for service stability
        run: |
          echo "â³ Waiting for service to be stable..."
          
          # ì„œë¹„ìŠ¤ ì•ˆì •í™” ëŒ€ê¸°
          aws ecs wait services-stable \
            --cluster fog-cluster \
            --services booking-service \
            --region ap-northeast-2
          
          echo "âœ… Service is now stable"

      - name: Verify deployment
        run: |
          echo "ğŸ” Verifying deployment..."
          
          # ë°°í¬ ìƒíƒœ í™•ì¸
          SERVICE_STATUS=$(aws ecs describe-services \
            --cluster fog-cluster \
            --services booking-service \
            --region ap-northeast-2 \
            --query 'services[0].status' \
            --output text)
          
          RUNNING_COUNT=$(aws ecs describe-services \
            --cluster fog-cluster \
            --services booking-service \
            --region ap-northeast-2 \
            --query 'services[0].runningCount' \
            --output text)
          
          DESIRED_COUNT=$(aws ecs describe-services \
            --cluster fog-cluster \
            --services booking-service \
            --region ap-northeast-2 \
            --query 'services[0].desiredCount' \
            --output text)
          
          echo "ğŸ“Š Deployment Status:"
          echo "  - Service Status: $SERVICE_STATUS"
          echo "  - Running Tasks: $RUNNING_COUNT"
          echo "  - Desired Tasks: $DESIRED_COUNT"
          
          if [ "$SERVICE_STATUS" = "ACTIVE" ] && [ "$RUNNING_COUNT" -eq "$DESIRED_COUNT" ] && [ "$RUNNING_COUNT" -gt 0 ]; then
            echo "ğŸ‰ Deployment successful!"
          else
            echo "âŒ Deployment failed!"
            exit 1
          fi

      - name: Send deployment notification
        run: |
          echo "ğŸ“¢ Sending deployment notification..."
          
          aws sns publish \
            --region ap-northeast-1 \
            --topic-arn ${{ secrets.TOKYO_SNS_TOPIC_ARN }} \
            --message "ğŸ‰ Booking service deployment completed successfully! 
          
          Commit: ${{ github.sha }}
          Image: ${{ needs.build-and-push.outputs.outputs.registry }}/booking-service:latest
          Status: $SERVICE_STATUS
          Running Tasks: $RUNNING_COUNT
          
          Deployed at: $(date '+%Y-%m-%d %H:%M:%S KST')"

      - name: Update CloudWatch metrics
        run: |
          echo "ğŸ“ˆ Updating CloudWatch metrics..."
          
          aws cloudwatch put-metric-data \
            --region us-east-1 \
            --namespace "FOG/Deployments" \
            --metric-data MetricName=BookingServiceDeployments,Value=1,Unit=Count
          
          echo "âœ… CloudWatch metrics updated"